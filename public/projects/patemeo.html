<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cute Cat Letter</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/Draggable.min.js"></script>
    <style>
        :root {
            --envelope-width: min(450px, 90vw);
            --envelope-height: calc(var(--envelope-width) * 0.6667);
            --border-radius: calc(var(--envelope-width) * 0.033);
            --letter-padding: calc(var(--envelope-width) * 0.067);
            --heart-size: calc(var(--envelope-width)/2 * 0.133);
            --border-thickness: calc(var(--envelope-width) * 0.0067);
        }

        body {
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }

        .instruction-title {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-size: calc(var(--envelope-width)* 0.05);
            font-weight: bold;
            padding: 10px 20px;
            /* border-radius: 30px; */
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); */
            /* z-index: 100; */
            text-align: center;
            /* animation: bounce 2s infinite alternate; */
            white-space: nowrap;
        }

        @keyframes bounce {
            0% {
                transform: translateX(-50%) translateY(0);
            }

            100% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .scene {
            perspective: calc(var(--envelope-width) * 2.667);
            width: var(--envelope-width);
            height: var(--envelope-height);
            position: relative;
            margin: 0 auto;
            transform-style: preserve-3d;
            transform: rotate(-5deg) translateY(35%);
            /* Reduced rotation for better viewing */
        }

        .envelope {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.15s;
            /* Faster transition */
            cursor: pointer;
            transform-origin: center center;
        }

        /* Standardize border-radius for consistency */
        .envelope-front,
        .envelope-back,
        .flap,
        .letter {
            border-radius: var(--border-radius);
        }

        .envelope-front {
            width: 100%;
            height: 100%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translateZ(1px);
            box-shadow: 0 calc(var(--envelope-width) * 0.013) calc(var(--envelope-width) * 0.022) rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        /* Cat image container */
        .cat-image {
            position: absolute;
            width: calc(var(--envelope-width) * 0.4);
            height: auto;
            bottom: calc(var(--envelope-height) * 0.05);
        }

        .envelope-back {
            width: 100%;
            height: 100%;
            position: absolute;
            transform: rotateY(180deg) translateZ(1px);
            box-shadow: 0 calc(var(--envelope-width) * 0.013) calc(var(--envelope-width) * 0.022) rgba(0, 0, 0, 0.15);
        }

        .flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            transform-origin: top center;
            /* Initially closed (folded down) */
            transform: rotateX(180deg);
            z-index: 6;
            transition: transform 0.4s ease-out;
            /* Faster transition */
        }

        .flap::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: calc(var(--envelope-width) * 0.5) solid transparent;
            border-right: calc(var(--envelope-width) * 0.5) solid transparent;
            border-top: calc(var(--envelope-height) * 0.5) solid;
        }

        .flap-inside {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 53%;
            transform-origin: top center;
            /* Initially closed (folded down) */
            transform: rotateX(0deg);
            z-index: 3;
            transition: all .4s linear;
            /* Faster transition */
        }

        .flap-inside::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: calc(var(--envelope-width) * 0.5) solid transparent;
            border-right: calc(var(--envelope-width) * 0.5) solid transparent;
            border-top: calc(var(--envelope-height) * 0.5) solid #fffbeb;
        }

        .heart {
            position: absolute;
            left: 50%;
            top: 45%;
            transform: translateX(-50%);
            width: var(--heart-size);
            height: var(--heart-size);
            background-color: #e91e63;
            transform-origin: center center;
            animation: heartbeat 1s infinite alternate;
            z-index: 5;
        }

        .heart::before,
        .heart::after {
            content: '';
            position: absolute;
            width: var(--heart-size);
            height: var(--heart-size);
            background-color: #e91e63;
            border-radius: 50%;
        }

        .heart::before {
            left: calc(var(--heart-size) * -0.5);
        }

        .heart::after {
            top: calc(var(--heart-size) * -0.5);
        }

        .left-fold,
        .right-fold {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            z-index: 2;
            border-radius: var(--border-radius);
        }

        .bottom-fold {
            position: absolute;
            top: 50%;
            height: 51%;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        .bottom-fold div {
            position: absolute;
            top: 1px;
            height: 95%;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        .left-fold {
            left: 0;
            transform-origin: bottom right;
            clip-path: polygon(0 0%, 100% 50%, 0 100%);
        }

        .left-fold div {
            position: absolute;
            top: 3px;
            width: 98%;
            height: 98%;
            z-index: 2;
            border-radius: var(--border-radius);
            left: 2px;
            transform-origin: bottom right;
            clip-path: polygon(0 0%, 100% 50%, 0 100%);
        }

        .right-fold {
            right: 0;
            transform-origin: bottom left;
            clip-path: polygon(100% 0, 0 50%, 100% 100%);
        }

        .right-fold div {
            position: absolute;
            top: 3px;
            width: 98%;
            height: 98%;
            z-index: 2;
            border-radius: var(--border-radius);
            right: 2px;
            transform-origin: bottom right;
            clip-path: polygon(100% 0, 0 50%, 100% 100%);
        }

        .letter-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .letter {
            position: absolute;
            top: var(--envelope-height);
            left: calc(var(--envelope-width) * 0.033);
            width: calc(var(--envelope-width) - calc(var(--envelope-width) * 0.067));
            height: auto;
            z-index: 0;
            transform: translateY(calc(var(--envelope-width) * 0.033));
            box-shadow: 0 calc(var(--envelope-width) * 0.007) calc(var(--envelope-width) * 0.013) rgba(0, 0, 0, 0.15);
            cursor: grab;
        }

        .letter-content {
            padding: var(--letter-padding);
            font-size: max(16px, calc(var(--envelope-width) * 0.036));
            line-height: 1.6;
            text-align: center;
        }

        .paw-print {
            display: inline-block;
            width: calc(var(--envelope-width) * 0.067);
            height: calc(var(--envelope-width) * 0.067);
            border-radius: 50%;
            position: relative;
            margin: 0 calc(var(--envelope-width) * 0.018);
        }

        .paw-print::before,
        .paw-print::after {
            content: '';
            position: absolute;
            width: calc(var(--envelope-width) * 0.027);
            height: calc(var(--envelope-width) * 0.027);
            border-radius: 50%;
        }

        .paw-print::before {
            top: calc(var(--envelope-width) * -0.018);
            left: calc(var(--envelope-width) * 0.007);
        }

        .paw-print::after {
            top: calc(var(--envelope-width) * -0.018);
            right: calc(var(--envelope-width) * 0.007);
        }

        .toe {
            position: absolute;
            width: calc(var(--envelope-width) * 0.02);
            height: calc(var(--envelope-width) * 0.02);
            border-radius: 50%;
        }

        .toe-1 {
            bottom: calc(var(--envelope-width) * -0.013);
            left: 0;
        }

        .toe-2 {
            bottom: calc(var(--envelope-width) * -0.013);
            left: calc(var(--envelope-width) * 0.024);
        }

        .toe-3 {
            bottom: calc(var(--envelope-width) * -0.013);
            right: 0;
        }

        @keyframes heartbeat {
            0% {
                transform: translateX(-50%) scale(1);
            }

            100% {
                transform: translateX(-50%) scale(1.1);
            }
        }

        .little-hearts {
            position: absolute;
            z-index: 0;
        }

        .little-heart {
            position: absolute;
            width: calc(var(--envelope-width) * 0.033);
            height: calc(var(--envelope-width) * 0.033);
            background-color: #e91e63;
            transform-origin: center center;
            opacity: 0;
        }

        .little-heart::before,
        .little-heart::after {
            content: '';
            position: absolute;
            width: calc(var(--envelope-width) * 0.033);
            height: calc(var(--envelope-width) * 0.033);
            background-color: #e91e63;
            border-radius: 50%;
        }

        .little-heart::before {
            left: calc(var(--envelope-width) * -0.017);
        }

        .little-heart::after {
            top: calc(var(--envelope-width) * -0.017);
        }

        .stamped {
            position: absolute;
            top: calc(var(--envelope-width) * 0.033);
            right: calc(var(--envelope-width) * 0.033);
            width: calc(var(--envelope-width) * 0.133);
            height: calc(var(--envelope-width) * 0.133);
            border-radius: calc(var(--envelope-width) * 0.018);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .paw-stamp {
            width: calc(var(--envelope-width) * 0.1);
            height: calc(var(--envelope-width) * 0.1);
            position: relative;
        }

        .paw-center {
            width: calc(var(--envelope-width) * 0.049);
            height: calc(var(--envelope-width) * 0.049);
            border-radius: 50%;
            position: absolute;
            top: calc(var(--envelope-width) * 0.033);
            left: calc(var(--envelope-width) * 0.027);
        }

        .paw-toe {
            width: calc(var(--envelope-width) * 0.027);
            height: calc(var(--envelope-width) * 0.033);
            border-radius: 50%;
            position: absolute;
        }

        .paw-toe-1 {
            top: 0;
            left: calc(var(--envelope-width) * 0.013);
        }

        .paw-toe-2 {
            top: 0;
            left: calc(var(--envelope-width) * 0.047);
        }

        .paw-toe-3 {
            top: 0;
            left: calc(var(--envelope-width) * 0.08);
        }

        .clouds {
            position: absolute;
            width: 100%;
            height: 100vh;
            top: 0;
            left: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }

        .cloud {
            position: absolute;
            border-radius: 50%;
            opacity: 0.8;
        }

        /* Configure the clouds */
        .cloud:nth-child(1) {
            width: calc(var(--envelope-width) * 0.233);
            height: calc(var(--envelope-width) * 0.133);
            top: 20%;
            animation: float1 90s linear infinite;
        }

        .cloud:nth-child(2) {
            width: calc(var(--envelope-width) * 0.333);
            height: calc(var(--envelope-width) * 0.2);
            top: 50%;
            animation: float2 120s linear infinite;
        }

        .cloud:nth-child(3) {
            width: calc(var(--envelope-width) * 0.2);
            height: calc(var(--envelope-width) * 0.118);
            top: 30%;
            animation: float1 100s linear infinite;
            animation-delay: 10s;
        }

        .cloud:nth-child(4) {
            width: calc(var(--envelope-width) * 0.267);
            height: calc(var(--envelope-width) * 0.151);
            top: 70%;
            animation: float2 80s linear infinite;
            animation-delay: 20s;
        }

        /* Create cloud animations */
        @keyframes float1 {
            0% {
                transform: translateX(-100px) translateY(20px);
            }

            100% {
                transform: translateX(calc(100vw + 100px)) translateY(50px);
            }
        }

        @keyframes float2 {
            0% {
                transform: translateX(-150px) translateY(120px);
            }

            100% {
                transform: translateX(calc(100vw + 150px)) translateY(90px);
            }
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .cloud::before {
            width: 60%;
            height: 100%;
            top: -40%;
            left: 10%;
        }

        .cloud::after {
            width: 55%;
            height: 100%;
            top: -25%;
            right: 10%;
        }

        .actions {
            position: absolute;
            z-index: 10;
            bottom: 10vh;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Media queries for different screen sizes */
        @media (max-width: 768px) {
            :root {
                --envelope-width: min(400px, 95vw);
            }

            .instruction-title {
                font-size: calc(var(--envelope-width) * 0.045);
                padding: 8px 16px;
                top: 10%;
            }
        }

        @media (max-width: 640px) {
            :root {
                --envelope-width: min(350px, 95vw);
            }

            /* Adjust text for smaller screens */
            .letter-content {
                font-size: max(14px, calc(var(--envelope-width) * 0.036));
            }

            .instruction-title {
                font-size: calc(var(--envelope-width) * 0.042);
                padding: 6px 14px;
            }
        }

        @media (max-width: 480px) {
            :root {
                --envelope-width: min(300px, 95vw);
            }

            /* Adjust text for even smaller screens */
            .letter-content {
                font-size: max(12px, calc(var(--envelope-width) * 0.036));
                padding: calc(var(--letter-padding) * 0.8);
            }

            .instruction-title {
                font-size: calc(var(--envelope-width) * 0.04);
                padding: 5px 12px;
                top: 8%;
            }

            .scene {
                transform: rotate(-3deg) translateY(30%);
            }
        }

        /* For touch devices */
        @media (hover: none) {
            .letter {
                cursor: default;
            }
        }
    </style>
</head>

<body class="bg-pink-50">
    <div class="clouds">
        <div class="cloud bg-white"></div>
        <div class="cloud bg-white"></div>
        <div class="cloud bg-white"></div>
        <div class="cloud bg-white"></div>
    </div>

    <div class="instruction-title text-gray-600">Nh·∫•p v√† k√©o ch·ªØ l√° th∆∞ ra!</div>

    <div class="scene">
        <div class="envelope">
            <div class="envelope-front bg-yellow-50">
                <div class="stamped border-2 border-dashed" style="border-color: #fdbdb1;">
                    <div class="paw-stamp">
                        <div class="paw-center" style="background-color: #fdbdb1;"></div>
                        <div class="paw-toe paw-toe-1" style="background-color: #fdbdb1;"></div>
                        <div class="paw-toe paw-toe-2" style="background-color: #fdbdb1;"></div>
                        <div class="paw-toe paw-toe-3" style="background-color: #fdbdb1;"></div>
                    </div>
                </div>
                <!-- Replaced cat face with image -->
                <img src="letter-cat.png" alt="Cute Cat" class="cat-image">
            </div>
            <div class="envelope-back bg-yellow-50">
                <div class="flap-inside"></div>
                <div class="heart"></div>
                <div class="left-fold bg-gray-800">
                    <div class="bg-yellow-50"></div>
                </div>
                <div class="right-fold bg-gray-800">
                    <div class="bg-yellow-50"></div>
                </div>
                <div class="bottom-fold bg-gray-800">
                    <div class="bg-yellow-50"></div>
                </div>
                <div style="
                        overflow: hidden;
                        width: 100%;
                        height: 200%;
                        position: absolute;
                        bottom: 0;
                    ">
                    <div class="letter-container">
                        <div class="letter bg-white">
                            <div class="letter-content text-gray-800">
                                <h2 class="text-2xl font-bold text-pink-500 mb-5">Meow there! üê±</h2>
                                <p class="mb-4">Just a quick note to say you're absolutely purr-fect!</p>
                                <p class="mb-4">Your friendship means the world to me, and I'm so lucky to have you in
                                    my life.</p>
                                <p class="mb-5">Remember to always stay pawsitive and never lose your curiosity!</p>
                                <p class="mb-4">üê±</p>
                                <div class="mb-3">
                                    <span class="paw-print bg-pink-300">
                                        <span class="toe toe-1 bg-pink-300"></span>
                                        <span class="toe toe-2 bg-pink-300"></span>
                                        <span class="toe toe-3 bg-pink-300"></span>
                                    </span>
                                    <span class="paw-print bg-pink-300">
                                        <span class="toe toe-1 bg-pink-300"></span>
                                        <span class="toe toe-2 bg-pink-300"></span>
                                        <span class="toe toe-3 bg-pink-300"></span>
                                    </span>
                                    <span class="paw-print bg-pink-300">
                                        <span class="toe toe-1 bg-pink-300"></span>
                                        <span class="toe toe-2 bg-pink-300"></span>
                                        <span class="toe toe-3 bg-pink-300"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="little-hearts">
            <div class="little-heart heart-1"></div>
            <div class="little-heart heart-2"></div>
            <div class="little-heart heart-3"></div>
            <div class="little-heart heart-4"></div>
            <div class="little-heart heart-5"></div>
        </div>
        <div class="gift-box"
            style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -90%); z-index: 10;">
            <img src="box-closed.png" alt="Gift box" style="max-width: 100%;">
        </div>
        <div class="gift-box-opened"
            style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -90%); z-index: 10;">
            <img src="box-opened.png" alt="Opened gift box" style="max-width: 100%;">
        </div>
    </div>

    <div class="actions">
        <button
            class="next-btn py-2 px-6 rounded-full bg-blue-100 text-blue-800 font-semibold hover:bg-blue-200 transition-colors">M·ªü
            phong th∆∞</button>
    </div>

    <script>
        let step = 0;
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            const envelope = document.querySelector('.envelope');
            const flap = document.querySelector('.flap-inside');
            const flapInside = document.querySelector('.flap');
            const letter = document.querySelector('.letter');
            const hearts = document.querySelectorAll('.little-heart');
            const nextStepBtn = document.querySelector('.next-btn');
            const instructionTitle = document.querySelector('.instruction-title');

            let isOpen = false;
            let isFlipped = false;

            // Get actual element dimensions directly
            const envelopeWidth = envelope.offsetWidth;

            // Initialize GSAP Draggable with free dragging capability
            const draggable = Draggable.create(letter, {
                type: "y",
                bounds: {
                    minY: (-envelopeWidth * 0.7),
                    maxY: envelopeWidth * 0.033
                },
                onDragStart: function () {
                    this.update();

                    // If we're at step 1 and the user starts dragging, progress to step 2
                    if (step === 1) {
                        step = 2;

                        // Animate hearts when dragging starts
                        gsap.to(hearts, {
                            y: function (index) {
                                return -(envelopeWidth * 0.5) - Math.random() * envelopeWidth * 0.3;
                            },
                            opacity: 0.9,
                            scale: function (index) {
                                return 1 + Math.random() * 0.5;
                            },
                            duration: function (index) {
                                return 0.8 + Math.random() * 0.6;
                            },
                            stagger: 0.1,
                            ease: "power1.out"
                        });

                        // Update the button text
                        nextStepBtn.textContent = "Ti·∫øp t·ª•c";
                    }
                }
            })[0];

            // Disable dragging initially
            draggable.disable();

            // Position hearts randomly
            hearts.forEach((heart, index) => {
                gsap.set(heart, {
                    x: Math.random() * envelopeWidth - envelopeWidth / 2,
                    y: Math.random() * (envelopeWidth * 0.33) - (envelopeWidth * 0.167)
                });
            });

            nextStepBtn.addEventListener('click', function () {
                if (step == 0) {
                    envelope.click();
                } else if (step == 1) {
                    // Pull out the letter with a smoother animation
                    gsap.to(letter, {
                        y: -envelopeWidth * 0.65, // Slightly less to avoid overshooting
                        duration: 1.2, // Slightly faster
                        ease: "power2.out",
                        onComplete: function () {
                            step = 2;

                            // Animate hearts with staggered timing for natural feel
                            
                        }
                    });
                    gsap.to(hearts, {
                                y: function (index) {
                                    return -(envelopeWidth * 0.5) - Math.random() * envelopeWidth * 0.3;
                                },
                                opacity: 0.9,
                                scale: function (index) {
                                    return 1 + Math.random() * 0.5;
                                },
                                duration: function (index) {
                                    return 0.8 + Math.random() * 0.6;
                                },
                                stagger: 0.1,
                                ease: "power1.out"
                            });
                    nextStepBtn.textContent = "Ti·∫øp t·ª•c";
                } else if (step == 2) {
                    // Step 3: Retract letter with smoother animation
                    step = 3;

                    gsap.to(letter, {
                        y: envelopeWidth * 0.033,
                        duration: 1,
                        ease: "power2.inOut",
                        onComplete: function () {
                            draggable.disable();
                        }
                    });

                    // Fade out hearts smoothly
                    gsap.to(hearts, {
                        opacity: 0,
                        scale: 0.5,
                        duration: 0.6,
                        stagger: 0.05,
                        ease: "power1.out"
                    });

                    setTimeout(function () {
                        const giftBox = document.querySelector('.gift-box');

                        // Hide instruction title when transitioning to gift box
                        gsap.to(instructionTitle, {
                            opacity: 0,
                            y: -20,
                            duration: 0.5,
                            ease: "power1.out"
                        });

                        gsap.to(envelope, {
                            opacity: 0,
                            scale: 1.1, // Less extreme scaling for smoother look
                            y: envelopeWidth * 0.1, // Less movement for smoother transition
                            duration: 1,
                            ease: "power2.inOut",
                            onComplete: function () {
                                envelope.style.display = 'none';
                                giftBox.style.display = 'block';
                                giftBox.style.opacity = '0';

                                gsap.to(giftBox, {
                                    opacity: 1,
                                    scale: 1.4, // Less extreme for smoother animation
                                    duration: 0.8,
                                    ease: "back.out(1.2)",
                                    onComplete: function () {
                                        gsap.to(giftBox, {
                                            scale: 1.3, // Subtle bounce
                                            duration: 0.5,
                                            ease: "elastic.out(1, 0.3)"
                                        });

                                        // Update button text for next step
                                        nextStepBtn.textContent = "M·ªü qu√†";
                                    }
                                });
                            }
                        });
                    }, 800); // Slightly faster timing
                } else if (step == 3) {
                    // Step 4: Open the gift box with improved animations and effects
                    step = 4;

                    // Get gift box elements
                    const closedBox = document.querySelector('.gift-box');
                    const openedBox = document.querySelector('.gift-box-opened');

                    // Create effects container if it doesn't exist
                    let effectsContainer = document.querySelector('.effects-container');
                    if (!effectsContainer) {
                        effectsContainer = document.createElement('div');
                        effectsContainer.className = 'effects-container';
                        effectsContainer.style.position = 'absolute';
                        effectsContainer.style.width = '100%';
                        effectsContainer.style.height = '100%';
                        effectsContainer.style.top = '0';
                        effectsContainer.style.left = '0';
                        effectsContainer.style.pointerEvents = 'none';
                        effectsContainer.style.zIndex = '20';
                        document.querySelector('.scene').appendChild(effectsContainer);
                    }

                    // Bright colors matching packaging
                    const colors = [
                        '#FFD700', // Yellow
                        '#5DADE2', // Blue
                        '#FF6B8B', // Pink
                        '#58D68D', // Green
                        '#E74C3C', // Red
                        '#9B59B6'  // Purple
                    ];

                    // Create and animate confetti with increased count for more explosive effect
                    const confettiCount = 150; // Increased from 80
                    for (let i = 0; i < confettiCount; i++) {
                        // Faster release of confetti for more explosive burst
                        setTimeout(() => {
                            createConfetti(effectsContainer, colors, envelopeWidth);
                        }, i * 2); // Much shorter delay between pieces
                    }

                    // Show the opened box
                    openedBox.style.display = 'block';
                    openedBox.style.opacity = '0';

                    gsap.to(openedBox, {
                        opacity: 1,
                        scale: 1.7,
                        duration: 0.1,
                        ease: "power1.out"
                    });

                    closedBox.style.display = 'none';

                    // Final animation for the opened box
                    gsap.to(openedBox, {
                        scale: 1.6,
                        duration: 0.2,
                        delay: 0.05,
                        ease: "elastic.out(1, 0.3)"
                    });

                    nextStepBtn.textContent = "Ho√†n th√†nh";
                }
            });

            // Enhanced createConfetti function for more explosive effect
            function createConfetti(container, colors, baseWidth) {
                const confetti = document.createElement('div');
                // Increase size variety for more dynamic effect
                const size = Math.random() * baseWidth * 0.025 + baseWidth * 0.01;

                confetti.style.position = 'absolute';
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size * (Math.random() * 0.8 + 0.6)}px`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                // More shape variety (rectangles, circles, and triangles)
                const shapeType = Math.random();
                if (shapeType > 0.7) {
                    confetti.style.borderRadius = '50%'; // Circle
                } else if (shapeType > 0.4) {
                    confetti.style.borderRadius = '0'; // Square/rectangle
                } else {
                    // Triangle shape using clip-path
                    confetti.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                }

                confetti.style.opacity = Math.random() * 0.8 + 0.4;

                // Position at center of container
                confetti.style.top = '50%';
                confetti.style.left = '50%';
                confetti.style.transform = 'translate(-50%, -50%)';

                container.appendChild(confetti);

                // More dramatic explosion effect
                const angle = Math.random() * Math.PI * 2;
                // Increase distance for more explosive burst
                const distance = baseWidth * (0.4 + Math.random() * 1.2);
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance - baseWidth * 0.2;

                // Initial burst animation - faster and more explosive
                gsap.to(confetti, {
                    x: x,
                    y: y,
                    rotation: Math.random() * 720 - 360, // More rotation
                    scale: 0.7 + Math.random() * 0.6,
                    duration: 0.4 + Math.random() * 0.6, // Faster for explosion
                    ease: "power3.out", // More explosive easing
                    onComplete: function () {
                        // After explosion, add more natural falling physics
                        gsap.to(confetti, {
                            y: `+=${baseWidth * 1.2}`, // Fall further
                            x: `+=${(Math.random() - 0.5) * baseWidth * 0.3}`, // Drift sideways
                            rotation: `+=${Math.random() * 360 - 180}`, // Continue rotating
                            opacity: 0,
                            scale: Math.random() * 0.5 + 0.2, // Shrink while falling
                            duration: 1.5 + Math.random(), // Longer fall duration
                            delay: Math.random() * 0.3, // Staggered falling
                            ease: "power1.in",
                            onComplete: function () {
                                confetti.remove();
                            }
                        });
                    }
                });
            }

            // Click event for the envelope
            envelope.addEventListener('click', function () {
                if (!isFlipped) {
                    // First click: Flip the envelope
                    isFlipped = true;
                    step = 1;

                    // Hide instruction when envelope is clicked
                    gsap.to(instructionTitle, {
                        opacity: 0,
                        y: -20,
                        duration: 0.5,
                        ease: "power1.out"
                    });

                    // Start opening the flap during the rotation - smoother timing
                    gsap.to(flap, {
                        rotationX: 30,
                        duration: 0.6,
                        delay: 0.2,
                        ease: "power1.inOut"
                    });

                    gsap.to(flapInside, {
                        rotationX: 210,
                        duration: 0.6,
                        delay: 0.2,
                        ease: "power1.inOut"
                    });

                    // Animate the envelope rotation with smoother movement
                    gsap.to(envelope, {
                        rotationY: 180,
                        duration: 1.2, // Slightly faster
                        ease: "power2.inOut",
                        y: -envelopeWidth * 0.05, // Less dramatic lift
                        onComplete: function () {
                            // Show instruction title again with new text
                            instructionTitle.textContent = "K√©o l√° th∆∞ l√™n ƒë·ªÉ ƒë·ªçc!";
                            gsap.to(instructionTitle, {
                                opacity: 1,
                                y: 0,
                                duration: 0.5,
                                delay: 0.3,
                                ease: "power1.out"
                            });
                        }
                    });

                    // After rotation, continue opening the flap
                    setTimeout(function () {
                        openFlap();
                        nextStepBtn.textContent = "Xem th∆∞";
                    }, 400); // Slightly faster timing
                }
            });

            function openFlap() {
                if (!isOpen) {
                    isOpen = true;

                    // Complete opening the flap with smoother animation
                    gsap.to(flap, {
                        rotationX: -180,
                        duration: 1.2,
                        ease: "power2.inOut",
                        onComplete: function () {
                            // Enable letter dragging
                            draggable.enable();

                            // Animate hearts with staggered timing for more natural rise
                            hearts.forEach((heart, index) => {
                                gsap.to(heart, {
                                    y: -(envelopeWidth * 0.25) - Math.random() * envelopeWidth * 0.25,
                                    x: envelopeWidth * 0.15 * (Math.random() - 0.5),
                                    rotation: Math.random() * 360,
                                    scale: 0.7 + Math.random() * 0.6,
                                    opacity: 0.7,
                                    duration: 0.8 + Math.random() * 1.5,
                                    delay: 0.08 * index,
                                    ease: "power1.out"
                                });
                            });
                        }
                    });

                    gsap.to(flapInside, {
                        rotationX: 360,
                        duration: 0.7,
                        ease: "power2.inOut"
                    });

                    flap.style.height = "50%";
                    setTimeout(() => {
                        flap.style.zIndex = "0";
                        flap.style.height = "47%";
                    }, 800);
                }
            }

            // Handle window resizing with improved responsiveness
            window.addEventListener('resize', function () {
                // Get actual element dimensions after resize
                const newEnvelopeWidth = envelope.offsetWidth;

                // Update draggable bounds
                draggable.vars.bounds = {
                    minY: -newEnvelopeWidth * 0.7,
                    maxY: newEnvelopeWidth * 0.033
                };

                draggable.update();
            });
        });
    </script>
</body>

</html>